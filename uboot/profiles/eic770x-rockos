UBOOT_BRANCH=rockos-dev
UBOOT_SBI_BRANCH=rockos-dev
UBOOT_GIT=https://github.com/rockos-riscv/rockos-u-boot.git
UBOOT_SBI=1
UBOOT_SBI_GIT=https://github.com/rockos-riscv/rockos-opensbi.git
UBOOT_SBI_PLATFORM=eswin/eic770x
UBOOT_SBI_MAKE_ARGS="FW_PAYLOAD=y CHIPLET=BR2_CHIPLET_1 CHIPLET_DIE_AVAILABLE=BR2_CHIPLET_1_DIE0_AVAILABLE MEM_MODE=BR2_MEMMODE_FLAT PLATFORM_CLUSTER_X_CORE=BR2_CLUSTER_4_CORE"
UBOOT_DEFCONFIGS=(eic7700_evb_defconfig hifive_premier_p550_defconfig)
UBOOT_RESULT_FILENAMES=(u-boot.bin u-boot.dtb)
UBOOT_SBI_RESULT_FILENAMES=(fw_payload.bin)

function override_compile() {

for UBOOT_DEFCONFIG in "${UBOOT_DEFCONFIGS[@]}"; do

echo "compile for $UBOOT_DEFCONFIG"

$MAKE_EXEC $UBOOT_DEFCONFIG
$MAKE_EXEC -j$(nproc)

UBOOT_OUTPUT_DIR=${UBOOT_DEFCONFIG%_defconfig}
mkdir -p $OUTPUT_DIR/${UBOOT_OUTPUT_DIR}

for UBOOT_RESULT_FILENAME in "${UBOOT_RESULT_FILENAMES[@]}"; do
        find . -name "$UBOOT_RESULT_FILENAME" | xargs -I @ cp -av @ $OUTPUT_DIR/${UBOOT_OUTPUT_DIR}/
done

pushd ../sbi
	UBOOT_SBI_PLATFORM=${UBOOT_SBI_PLATFORM:-generic}
	$MAKE_EXEC PLATFORM=$UBOOT_SBI_PLATFORM $UBOOT_SBI_MAKE_ARGS FW_FDT_PATH=$OUTPUT_DIR/${UBOOT_OUTPUT_DIR}/u-boot.dtb FW_PAYLOAD_PATH=$OUTPUT_DIR/${UBOOT_OUTPUT_DIR}/u-boot.bin -j$(nproc)
	for UBOOT_SBI_RESULT_FILENAME in "${UBOOT_SBI_RESULT_FILENAMES[@]}"; do
		find . -name "$UBOOT_SBI_RESULT_FILENAME" | xargs -I @ cp -av @ $OUTPUT_DIR/${UBOOT_OUTPUT_DIR}/
	done

	cp -v $OUTPUT_DIR/${UBOOT_OUTPUT_DIR}/fw_payload.bin sign/preload/
	pushd sign/preload
		sed -i "s#HOLDER#$(pwd)#g" bootchain.cfg
		../nsign bootchain.cfg
		cp -v bootloader_secboot_ddr5.bin $OUTPUT_DIR/${UBOOT_OUTPUT_DIR}/
	popd
popd

$MAKE_EXEC clean
	
done

}
